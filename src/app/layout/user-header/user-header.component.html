<header class="audience-header" [class.scrolled]="isScrolled">
  <div class="container">
    <div class="header-row">
      <!-- Left Section - CONDITIONAL: Show Search OR Breadcrumbs -->
      <div class="header-col left-section-col">
        <div class="left-section-content">
          <!-- Logo - ALWAYS VISIBLE -->
          <div class="logo-wrapper">
            <a [routerLink]="['/events']">
              <img class="logo" src="/assets/th_transparent_logo.png" alt="ticket-house-logo" />
            </a>
          </div>

          <!-- CONDITION 1: SHOW SEARCH + CITY on home/events page and default pages -->
          <div *ngIf="showSearchSection()" class="search-breadcrumb-container">
            <!-- Search -->
            <div class="search-wrapper">
              <div class="search">
                <input placeholder="Search for Events, Artists, Location..." aria-label="search"
                  (input)="onSearch($event)">
              </div>
            </div>
          </div>

          <!-- CONDITION 2: SHOW BREADCRUMBS on seat booking and payment pages -->
          <div *ngIf="!showSearchSection()" class="search-breadcrumb-container">
            <!-- Breadcrumbs -->
            <nav class="breadcrumbs">
              <span class="back-arrow" (click)="navigateBack()">←</span>

              <span class="crumb" [routerLink]="['/events']">Events</span>
              <span class="separator">›</span>

              <!-- Event Name (if available) -->
              <span *ngIf="eventId && eventNameSlug" class="crumb" (click)="navigateToEventBooking()">
                {{ eventTitle }}
              </span>
              <span *ngIf="eventId && eventNameSlug" class="separator">›</span>

              <!-- Current Page -->
              <span class="crumb active">{{ getCurrentPageName() }}</span>

              <!-- Next Step (only on seat booking page) -->
              <ng-container *ngIf="isSeatBookingPage()">
                <span class="separator">›</span>
                <span class="crumb muted">Review & Pay</span>
              </ng-container>
            </nav>
          </div>
        </div>
      </div>

      <!-- Right Column - ALWAYS SAME: User Actions -->
      <div class="header-col actions-col">
        <div class="user-actions">
          <!-- City Selector - ALWAYS VISIBLE (except maybe on payment) -->
          <!-- <div class="location muted" (click)="onCityChange('Pune')">Pune ▼</div> -->

          <!-- User Welcome Dropdown - When Logged In -->
          <!-- User Welcome Dropdown - When Logged In -->
          <div *ngIf="isUserLoggedIn" class="user-welcome-dropdown">
            <div class="user-welcome-trigger" (click)="toggleDropdown()">
              <!-- Desktop: Show Welcome, name and arrow -->
              <span class="desktop-welcome">Welcome, {{ getUserDisplayName() }}! ▼</span>
              <!-- Mobile: Show only user icon -->
              <span class="mobile-user-icon"><i class="bi bi-person-circle"></i></span>
            </div>
            <div *ngIf="showUserDropdown" class="user-dropdown-menu">
              <!-- Mobile-only user name display -->
              <div class="dropdown-user-info mobile-only">
                <div class="user-name-display">{{ getUserDisplayName() }}</div>
                <div class="user-email-display">{{ getUserEmail() }}</div>
              </div>
              <div class="dropdown-divider mobile-only"></div>
              <!-- <div class="dropdown-item" (click)="onViewProfile()">
                View Profile
              </div> -->
              <!-- <div class="user-email-display">{{ getUserEmail() }}</div> -->
              <div class="dropdown-item desktop-welcome">
                {{ getUserEmail() }}
              </div>
              <!-- <div class="dropdown-divider"></div> -->
              <div class="dropdown-item" (click)="onViewBookings()">
                My Bookings
              </div>
              <div class="dropdown-divider"></div>
              <div class="dropdown-item logout-item" (click)="onLogout()">
                <span class="logout-icon"><i class="bi bi-box-arrow-right"></i></span>
                Logout
              </div>
            </div>
          </div>

          <!-- Sign In Button - When Not Logged In -->
          <div *ngIf="!isUserLoggedIn" class="pill" (click)="onSignIn()">Sign In</div>
        </div>
      </div>
    </div>
  </div>
</header>

<!-- Auth Modal -->
<div *ngIf="showAuthModal" class="modal-overlay">
  <div class="modal-content auth-modal">
    <div class="modal-header">
      <h3>{{ isLoginMode ? 'Sign In' : 'Create Account' }}</h3>
      <button class="modal-close" (click)="onCloseAuthModal()">×</button>
    </div>
    <div class="modal-body">
      <!-- Progress Steps for Signup -->
      <div *ngIf="!isLoginMode" class="signup-steps">
        <div class="step" [class.active]="signupStep === 1">
          <span class="step-number">1</span>
          <span class="step-text">Account Details</span>
        </div>
        <div class="step" [class.active]="signupStep === 2">
          <span class="step-number">2</span>
          <span class="step-text">Verify Email</span>
        </div>
      </div>

      <!-- Login Form -->
      <!-- Login Form - Update this section in user-header.component.html -->
      <div *ngIf="isLoginMode && !showOTPVerification && !showForgotPassword" class="login-section">
        <div class="form-group">
          <input type="email" [(ngModel)]="loginEmail" placeholder="Email" [disabled]="isLoading">
        </div>
        <div class="form-group password-field">
          <input [type]="showLoginPassword ? 'text' : 'password'" [(ngModel)]="loginPassword" placeholder="Password"
            [disabled]="isLoading">
          <button type="button" class="password-toggle" (click)="showLoginPassword = !showLoginPassword"
            [attr.aria-label]="showLoginPassword ? 'Hide password' : 'Show password'">
            <i class="bi" [class.bi-eye]="!showLoginPassword" [class.bi-eye-slash]="showLoginPassword"></i>
          </button>
        </div>

        <!-- Forgot Password Link - Bottom Right -->
        <div class="forgot-password-container">
          <a class="forgot-password-link" (click)="onForgotPassword()">Forgot Password?</a>
        </div>

        <button class="auth-btn" (click)="onLogin()" [disabled]="isLoading || !loginEmail || !loginPassword">
          <span *ngIf="!isLoading">Sign In</span>
          <span *ngIf="isLoading">Signing In...</span>
        </button>
        <div class="auth-footer">
          <p>Don't have an account?
            <a (click)="switchToSignup()">Sign Up</a>
          </p>
        </div>
      </div>

      <!-- Forgot Password - Email OTP Step -->
      <div *ngIf="isLoginMode && showForgotPassword && forgotPasswordStep === 1" class="forgot-password-section">
        <div class="forgot-header">
          <h4>Reset Password</h4>
          <p>Enter your email address to receive an OTP</p>
        </div>

        <div class="form-group">
          <input type="email" [(ngModel)]="forgotPasswordEmail" placeholder="Email" [disabled]="isLoading">
        </div>

        <button class="auth-btn" (click)="sendForgotPasswordOTP()" [disabled]="isLoading || !forgotPasswordEmail">
          <span *ngIf="!isLoading">Send OTP</span>
          <span *ngIf="isLoading">Sending OTP...</span>
        </button>

        <div class="auth-footer">
          <a (click)="backToLogin()">← Back to Login</a>
        </div>
      </div>

      <!-- Forgot Password - OTP Verification Step -->
      <div *ngIf="isLoginMode && showForgotPassword && forgotPasswordStep === 2" class="otp-verification-section">
        <div class="verification-header">
          <h4>Verify OTP</h4>
          <p>Enter the 4-digit code sent to<br>
            <strong>{{ forgotPasswordEmail }}</strong>
          </p>
        </div>

        <div class="otp-input-container">
          <div class="otp-inputs">
            <input *ngFor="let i of [0,1,2,3]; let idx = index" type="text" maxlength="1"
              [(ngModel)]="forgotPasswordOtpDigits[idx]" (input)="onForgotOtpInput($event, idx)"
              (keydown)="onForgotOtpKeyDown($event, idx)" [disabled]="isLoading" class="otp-digit">
          </div>
        </div>

        <div class="otp-timer" *ngIf="otpTimer > 0">
          OTP expires in: {{ formatOtpTimer() }}
        </div>

        <div class="otp-actions">
          <button class="resend-btn" (click)="resendForgotPasswordOTP()" [disabled]="otpTimer > 0 || isLoading">
            Resend OTP
          </button>
          <button class="verify-btn" (click)="verifyForgotPasswordOTP()"
            [disabled]="!isForgotOtpComplete() || isLoading">
            <span *ngIf="!isLoading">Verify OTP</span>
            <span *ngIf="isLoading">Verifying...</span>
          </button>
        </div>

        <div class="auth-footer">
          <a (click)="backToForgotStep1()">← Back to Email</a>
        </div>
      </div>

      <!-- Forgot Password - Set New Password Step -->
      <div *ngIf="isLoginMode && showForgotPassword && forgotPasswordStep === 3" class="set-password-section">
        <div class="forgot-header">
          <h4>Set New Password</h4>
          <p>Enter your new password below</p>
        </div>

        <!-- Email Field (Disabled) -->
        <div class="form-group">
          <input type="email" [value]="forgotPasswordEmail" placeholder="Email" disabled class="disabled-input">
        </div>

        <!-- New Password Field -->
        <div class="form-group password-field">
          <input [type]="showNewPassword ? 'text' : 'password'" [(ngModel)]="newPassword" placeholder="New Password"
            [disabled]="isLoading">
          <button type="button" class="password-toggle" (click)="showNewPassword = !showNewPassword"
            [attr.aria-label]="showNewPassword ? 'Hide password' : 'Show password'">
            <i class="bi" [class.bi-eye]="!showNewPassword" [class.bi-eye-slash]="showNewPassword"></i>
          </button>
        </div>

        <!-- Confirm Password Field -->
        <div class="form-group password-field">
          <input [type]="showConfirmPassword ? 'text' : 'password'" [(ngModel)]="confirmPassword"
            placeholder="Confirm Password" [disabled]="isLoading">
          <button type="button" class="password-toggle" (click)="showConfirmPassword = !showConfirmPassword"
            [attr.aria-label]="showConfirmPassword ? 'Hide password' : 'Show password'">
            <i class="bi" [class.bi-eye]="!showConfirmPassword" [class.bi-eye-slash]="showConfirmPassword"></i>
          </button>
        </div>

        <!-- Password Validation Messages -->
        <div *ngIf="newPassword && !isNewPasswordValid()" class="password-validation-container">
          <div class="password-requirements">
            <div class="requirement" [class.valid]="hasNewUpperCase()">
              <span class="requirement-icon">{{ hasNewUpperCase() ? '✓' : '○' }}</span>
              <span class="requirement-text">At least one uppercase letter</span>
            </div>
            <div class="requirement" [class.valid]="hasNewLowerCase()">
              <span class="requirement-icon">{{ hasNewLowerCase() ? '✓' : '○' }}</span>
              <span class="requirement-text">At least one lowercase letter</span>
            </div>
            <div class="requirement" [class.valid]="hasNewNumber()">
              <span class="requirement-icon">{{ hasNewNumber() ? '✓' : '○' }}</span>
              <span class="requirement-text">At least one number</span>
            </div>
            <div class="requirement" [class.valid]="hasNewSpecialChar()">
              <span class="requirement-icon">{{ hasNewSpecialChar() ? '✓' : '○' }}</span>
              <span class="requirement-text">At least one special character (@$!%*?&)</span>
            </div>
            <div class="requirement" [class.valid]="hasNewMinLength()">
              <span class="requirement-icon">{{ hasNewMinLength() ? '✓' : '○' }}</span>
              <span class="requirement-text">Minimum 8 characters</span>
            </div>
          </div>
        </div>

        <!-- Password Match Validation -->
        <div *ngIf="confirmPassword && newPassword !== confirmPassword" class="validation-error">
          <small>Passwords do not match</small>
        </div>

        <button class="auth-btn" (click)="setNewPassword()"
          [disabled]="isLoading || !isNewPasswordValid() || newPassword !== confirmPassword">
          <span *ngIf="!isLoading">Set Password</span>
          <span *ngIf="isLoading">Updating...</span>
        </button>

        <div class="auth-footer">
          <a (click)="backToLogin()">← Back to Login</a>
        </div>
      </div>

      <!-- Step 1: Signup Form -->
      <!-- Step 1: Signup Form -->
      <div *ngIf="!isLoginMode && signupStep === 1" class="signup-section">
        <div class="form-group">
          <input type="text" [(ngModel)]="signupFirstName" placeholder="First Name" [disabled]="isLoading"
            #firstName="ngModel" required minlength="2">
          <div *ngIf="firstName.invalid && (firstName.dirty || firstName.touched)" class="validation-error">
            <small *ngIf="firstName.errors?.['required']">First name is required</small>
            <small *ngIf="firstName.errors?.['minlength']">First name must be at least 2 characters</small>
          </div>
        </div>

        <div class="form-group">
          <input type="text" [(ngModel)]="signupLastName" placeholder="Last Name" [disabled]="isLoading"
            #lastName="ngModel" required minlength="2">
          <div *ngIf="lastName.invalid && (lastName.dirty || lastName.touched)" class="validation-error">
            <small *ngIf="lastName.errors?.['required']">Last name is required</small>
            <small *ngIf="lastName.errors?.['minlength']">Last name must be at least 2 characters</small>
          </div>
        </div>

        <div class="form-group">
          <input type="email" [(ngModel)]="signupEmail" placeholder="Email" [disabled]="isLoading" #email="ngModel"
            required email>
          <div *ngIf="email.invalid && (email.dirty || email.touched)" class="validation-error">
            <small *ngIf="email.errors?.['required']">Email is required</small>
            <small *ngIf="email.errors?.['email']">Please enter a valid email</small>
          </div>
        </div>

        <div class="form-group password-field">
          <input [type]="showSignupPassword ? 'text' : 'password'" [(ngModel)]="signupPassword" placeholder="Password"
            [disabled]="isLoading" #password="ngModel" required>
          <button type="button" class="password-toggle" (click)="showSignupPassword = !showSignupPassword"
            [attr.aria-label]="showSignupPassword ? 'Hide password' : 'Show password'">
            <!-- <i class="fa-solid" [class.fa-eye]="!showSignupPassword" [class.fa-eye-slash]="showSignupPassword"></i> -->
            <i class="bi" [class.bi-eye]="!showSignupPassword" [class.bi-eye-slash]="showSignupPassword"></i>
          </button>
        </div>

        <!-- Password validation messages - Only show when password is NOT valid and field is touched/dirty -->
        <div *ngIf="signupPassword && !isPasswordValid() && (password.dirty || password.touched)"
          class="password-validation-container">
          <div class="password-requirements">
            <div class="requirement" [class.valid]="hasUpperCase()">
              <span class="requirement-icon">{{ hasUpperCase() ? '✓' : '○' }}</span>
              <span class="requirement-text">At least one uppercase letter</span>
            </div>
            <div class="requirement" [class.valid]="hasLowerCase()">
              <span class="requirement-icon">{{ hasLowerCase() ? '✓' : '○' }}</span>
              <span class="requirement-text">At least one lowercase letter</span>
            </div>
            <div class="requirement" [class.valid]="hasNumber()">
              <span class="requirement-icon">{{ hasNumber() ? '✓' : '○' }}</span>
              <span class="requirement-text">At least one number</span>
            </div>
            <div class="requirement" [class.valid]="hasSpecialChar()">
              <span class="requirement-icon">{{ hasSpecialChar() ? '✓' : '○' }}</span>
              <span class="requirement-text">At least one special character (@$!%*?&)</span>
            </div>
            <div class="requirement" [class.valid]="hasMinLength()">
              <span class="requirement-icon">{{ hasMinLength() ? '✓' : '○' }}</span>
              <span class="requirement-text">Minimum 8 characters</span>
            </div>
          </div>
          <div class="validation-error password-error">
            <small>Password must meet all requirements above</small>
          </div>
        </div>

        <div class="form-row">
          <div class="form-group country-code">
            <select [(ngModel)]="signupCountryCode" [disabled]="isLoading">
              <option value="+91">+91 IN</option>
              <option value="+1">+1 US</option>
              <option value="+44">+44 UK</option>
              <option value="+61">+61 AU</option>
              <option value="+65">+65 SG</option>
            </select>
          </div>
          <div class="form-group phone-number">
            <input type="text" [(ngModel)]="signupPhone" placeholder="Phone Number (optional)" [disabled]="isLoading">
          </div>
        </div>

        <button class="auth-btn" (click)="onSignupStep1()"
          [disabled]="isLoading || !signupFirstName || !signupLastName || !signupEmail || !isPasswordValid() || !isValidSignupStep1()">
          <span *ngIf="!isLoading">Send OTP</span>
          <span *ngIf="isLoading">Sending OTP...</span>
        </button>

        <div class="auth-footer">
          <p>Already have an account?
            <a (click)="switchToLogin()">Sign In</a>
          </p>
        </div>
      </div>
      <!-- Step 2: OTP Verification -->
      <div *ngIf="signupStep === 2 || showOTPVerification" class="otp-verification-section">
        <div class="verification-header">
          <h4>Verify Your Email</h4>
          <p>Enter the 4-digit code sent to<br>
            <strong>{{ signupEmail || loginEmail }}</strong>
          </p>
        </div>
        <div class="otp-input-container">
          <div class="otp-inputs">
            <input *ngFor="let i of [0,1,2,3]; let idx = index" type="text" maxlength="1" [(ngModel)]="otpDigits[idx]"
              (input)="onOtpInput($event, idx)" (keydown)="onOtpKeyDown($event, idx)" [disabled]="isLoading"
              class="otp-digit">
          </div>
        </div>
        <div class="otp-timer" *ngIf="otpTimer > 0">
          OTP expires in: {{ formatOtpTimer() }}
        </div>
        <div class="otp-actions">
          <button class="resend-btn" (click)="resendOTP()" [disabled]="otpTimer > 0 || isLoading">
            Resend OTP
          </button>
          <button class="verify-btn" (click)="verifyOTP()" [disabled]="!isOtpComplete() || isLoading">
            <span *ngIf="!isLoading">Verify & Continue</span>
            <span *ngIf="isLoading">Verifying...</span>
          </button>
        </div>
        <div class="auth-footer" *ngIf="signupStep === 2">
          <a (click)="goBackToStep1()">← Back to Signup</a>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Overlay for dropdown -->
<div *ngIf="showUserDropdown" class="overlay" (click)="closeDropdownOnClickOutside($event)"></div>