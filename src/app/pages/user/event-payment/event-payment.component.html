<div class="audience-page audience-body">
  <!-- HEADER -->
  <!-- <header class="audience-header">
    <div class="container">
      <div class="header-row">
        <div class="header-col left-section-col">
          <div class="left-section-content">
            <div class="logo-wrapper">
                <img class="logo" src="/assets/ticket-house-logo.jpeg" alt="ticket-house-logo" />
            </div>
            <nav class="breadcrumbs">
              <span class="back-arrow" [routerLink]="['/events']">‚Üê</span>

              <span class="crumb" [routerLink]="['/events']">Events</span>
              <span class="separator">‚Ä∫</span>
              <span class="crumb" [routerLink]="['/event-booking', eventId, eventNameSlug]">{{ getFormattedEventTitle() }}</span>
              <span class="separator">‚Ä∫</span>

              <span class="crumb" [routerLink]="['/seats-booking', eventId, eventNameSlug]">Select Seats</span>
              <span class="separator">‚Ä∫</span>

              <span class="crumb active">Review & Pay</span>
            </nav>
          </div>
        </div>
        <div class="header-col actions-col">
          <div class="user-actions">
            <div class="location muted">Pune ‚ñº</div>
            <div *ngIf="isUserLoggedIn" class="user-welcome-dropdown">
              <div class="user-welcome-trigger" (click)="toggleDropdown()">
                Welcome, {{ getUserDisplayName() }}! ‚ñº
              </div>
              <div *ngIf="showUserDropdown" class="user-dropdown-menu">
                <div class="dropdown-item" (click)="onViewProfile()">
                  View Profile
                </div>
                <div class="dropdown-item" (click)="onViewBookings()">
                  My Bookings
                </div>
                <div class="dropdown-divider"></div>
                <div class="dropdown-item logout-item" (click)="onLogout()">
                  <span class="logout-icon">üö™</span>
                  Logout
                </div>
              </div>
            </div>
            <div *ngIf="!isUserLoggedIn" class="pill" (click)="onSignIn()">Sign In</div>
          </div>
        </div>
      </div>
    </div>
  </header> -->

  <!-- PAGE CONTENT -->
  <main class="payment-page">
    <div class="payment-container">
      <!-- LEFT SECTION -->
      <section class="payment-left">
        <div class="payment-card">
          <h3 class="card-title">Please select from the following option(s)</h3>

          <!-- M Ticket -->
          <label class="radio-row">
            <input type="radio" checked />
            <div class="radio-content">
              <div class="radio-title">M-Ticket</div>
              <div class="radio-sub">Save the planet. Use your phone as a ticket.</div>
            </div>
          </label>

          <!-- Info Box -->
          <div class="info-box">
            <h4>M-Ticket Information</h4>
            <ol>
              <li>
                Customer(s) can access their ticket(s) from the 'My Profile' section on the
                app/mobile-web.
              </li>
              <li>It is mandatory to present the ticket(s) via app/mobile-web at the venue.</li>
              <li>No physical ticket(s) are required.</li>
            </ol>
          </div>

          <!-- Booking Summary -->
          <div class="booking-summary" *ngIf="seatSelections.length > 0">
            <h4>Your Booking Details</h4>
            <div class="summary-item" *ngFor="let seat of seatSelections">
              <div class="seat-info">
                <!-- <span class="seat-name">Seat Type {{ seat.SeatTypeId }}</span> -->
                 <span class="seat-name">{{ seat.SeatName || 'Seat Type ' + seat.SeatTypeId }}</span>
                <span class="seat-quantity">√ó {{ seat.Quantity }}</span>
              </div>
            </div>
          </div>
        </div>
      </section>

      <aside class="payment-right">
        <div class="summary-card" *ngIf="eventTitle">
          <div class="ticket-information">
            <span class="ticket-information-title">Important Information</span>
            <div class="ticket-info-div">
              <div class="check-out-title py-2">Ticket Access & Entry Guidelines</div>
              <div class="ticket-information-points">1) Customer(s) can access their ticket(s) from the 'My Profile' section on the app/mobile-web.</div>
              <div class="ticket-information-points">2) It is mandatory to present the ticket(s) in my profile section via app/mobile-web at the venue.</div>
              <div class="ticket-information-points">3) No physical ticket(s) are required to enter the venue.</div>

            </div>
          </div>


        </div>

        <div class="price-breakup" *ngIf="totalAmount > 0">
          <div class="row my-0 pb-2 border-bottom">
            <div class="d-flex justify-content-between mb-2"><span class="check-out-title">{{ eventTitle }}</span><span class="check-out-title">‚Çπ{{ totalAmount }}</span></div>
            <span>{{ getTotalTickets() }} Tickets</span>
          </div>
          
          <div class="row my-0">
            <span class="check-out-title" *ngIf="eventDate">{{ formatDate(eventDate) }}</span>
            <span *ngIf="eventTime">{{ eventTime }}</span>
          </div>

          <div class="row my-0">
            <span class="muted">Venue</span>
            <span  class="check-out-title" *ngIf="eventLocation">{{ eventLocation }}</span>
          </div>
          
          <div class="row py-2 border-bottom">
            <div *ngFor="let seat of seatSelections" >
               <div class="seat-name">{{ seat.SeatName || 'Seat Type ' + seat.SeatTypeId | uppercase}}({{seat.Price || '1299'}}): {{ seat.Quantity }} ticket(s)</div>
            </div>
          </div>


          <div class="row my-0">
            <div class="d-flex justify-content-between">
              <span>Sub-total</span>
              <span class="text-black">‚Çπ{{ totalAmount }}</span>
            </div>
          </div>

          <div class="row my-0 border-bottom">

            <!-- Header -->
            <div 
              class="d-flex justify-content-between booking-header"
              (click)="toggleFeeBreakup()"
            >
              <span>
                Booking Fees 
                <span class="arrow-icon" [class.rotate]="showFeeBreakup">
                  ‚ñº
                </span>
              </span>

              <span class="text-black">
                ‚Çπ{{ (convenienceFee + gstTotal) | number:'1.2-2' }}
              </span>
            </div>

            <!-- Accordion Content -->
            <div class="accodian-content px-4" [class.open]="showFeeBreakup">

              <div class="d-flex">
                <span class="price-distribution">Convenience Fee (6%): </span>
                <span class="price-distribution">‚Çπ{{ convenienceFee | number:'1.2-2' }}</span>
              </div>

              <div class="d-flex mb-2">
                <span class="price-distribution">GST (18% on Convenience Fee): </span>
                <span class="price-distribution">‚Çπ{{ gstTotal | number:'1.2-2' }}</span>
              </div>

            </div>

          </div>







          <div class="row my-0">
   
            <div class="d-flex justify-content-between my-2">
              <span  class="check-out-total-title">Total Amount</span>
              <span  class="check-out-total-amount">‚Çπ{{ finalAmount }}</span>
            </div>
          </div>

          <div class="state-select my-0 d-none">
            <label>Select State</label>
            <select [(ngModel)]="selectedState">
              <option selected>Maharashtra</option>
              <!-- <option>Delhi</option>
              <option>Karnataka</option>
              <option>Tamil Nadu</option>
              <option>Gujarat</option> -->
            </select>
          </div>

          <p class="my-0 pay-consent">By proceeding, I express my consent to complete this transaction.</p>

           <div class="mobile-pay-bar">

          <button 
            class="pay-btn" 
            (click)="onProceedToPay()" 
            [disabled]="isProcessing || seatSelections.length === 0">
            <span *ngIf="!isProcessing">Proceed to Pay ‚Çπ{{ finalAmount }}</span>
            <span *ngIf="isProcessing">Processing...</span>
          </button>

          </div>


          <div *ngIf="isProcessing" class="loading-state">
            <div class="spinner"></div>
            <p>Please wait while we process your request...</p>
          </div>
        </div>
      </aside>
    </div>
  </main>

  
  <!-- Updated Login/Signup Modal -->
  <div *ngIf="showAuthModal" class="modal-overlay">
    <div class="modal-content auth-modal">
      <div class="modal-header">
        <h3>{{ isLoginMode ? 'Sign In' : 'Create Account' }}</h3>
        <button class="modal-close" (click)="onCloseAuthModal()">√ó</button>
      </div>

      <div class="modal-body">
        <!-- Progress Steps for Signup -->
        <div *ngIf="!isLoginMode" class="signup-steps">
          <div class="step" [class.active]="signupStep === 1">
            <span class="step-number">1</span>
            <span class="step-text">Account Details</span>
          </div>
          <div class="step" [class.active]="signupStep === 2">
            <span class="step-number">2</span>
            <span class="step-text">Verify Email</span>
          </div>
        </div>

        <!-- Login Form -->
        <div *ngIf="isLoginMode && !showOTPVerification" class="login-section">
          <div class="form-group">
            <input type="email" [(ngModel)]="loginEmail" placeholder="Email" [disabled]="isLoading">
          </div>
          <div class="form-group">
            <input type="password" [(ngModel)]="loginPassword" placeholder="Password" [disabled]="isLoading">
          </div>

          <button class="auth-btn" (click)="onLogin()" [disabled]="isLoading || !loginEmail || !loginPassword">
            <span *ngIf="!isLoading">Sign In</span>
            <span *ngIf="isLoading">Signing In...</span>
          </button>

          <div class="auth-footer">
            <p>Don't have an account?
              <a (click)="switchToSignup()">Sign Up</a>
            </p>
          </div>
        </div>

        <!-- Step 1: Signup Form -->
        <div *ngIf="!isLoginMode && signupStep === 1" class="signup-section">
          <div class="form-group">
            <input type="text" [(ngModel)]="signupFirstName" placeholder="First Name" [disabled]="isLoading">
          </div>
          <div class="form-group">
            <input type="text" [(ngModel)]="signupLastName" placeholder="Last Name" [disabled]="isLoading">
          </div>
          <div class="form-group">
            <input type="email" [(ngModel)]="signupEmail" placeholder="Email" [disabled]="isLoading">
          </div>
          <div class="form-group">
            <input type="password" [(ngModel)]="signupPassword" placeholder="Password (min. 8 characters)"
              [disabled]="isLoading">
          </div>
          <div class="form-row">
            <div class="form-group country-code">
              <select [(ngModel)]="signupCountryCode" [disabled]="isLoading">
                <option value="+91">+91 IN</option>
                <option value="+1">+1 US</option>
                <option value="+44">+44 UK</option>
                <option value="+61">+61 AU</option>
                <option value="+65">+65 SG</option>
              </select>
            </div>
            <div class="form-group phone-number">
              <input type="text" [(ngModel)]="signupPhone" placeholder="Phone Number (optional)" [disabled]="isLoading">
            </div>
          </div>

          <button class="auth-btn" (click)="onSignupStep1()"
            [disabled]="isLoading || !signupFirstName || !signupEmail || !signupPassword || !isValidSignupStep1()">
            <span *ngIf="!isLoading">Send OTP</span>
            <span *ngIf="isLoading">Sending OTP...</span>
          </button>

          <div class="auth-footer">
            <p>Already have an account?
              <a (click)="switchToLogin()">Sign In</a>
            </p>
          </div>
        </div>

        <!-- Step 2: OTP Verification -->
        <div *ngIf="signupStep === 2 || showOTPVerification" class="otp-verification-section">
          <div class="verification-header">
            <h4>Verify Your Email</h4>
            <p>Enter the 4-digit code sent to<br>
              <strong>{{ signupEmail || loginEmail }}</strong>
            </p>
          </div>

          <div class="otp-input-container">
            <div class="otp-inputs">
              <input *ngFor="let i of [0,1,2,3]; let idx = index" type="text" maxlength="1" [(ngModel)]="otpDigits[idx]"
                (input)="onOtpInput($event, idx)" (keydown)="onOtpKeyDown($event, idx)" [disabled]="isLoading"
                class="otp-digit">
            </div>
          </div>

          <div class="otp-timer" *ngIf="otpTimer > 0">
            OTP expires in: {{ formatOtpTimer() }}
          </div>

          <div class="otp-actions">
            <button class="resend-btn" (click)="resendOTP()" [disabled]="otpTimer > 0 || isLoading">
              Resend OTP
            </button>

            <button class="verify-btn" (click)="verifyOTP()" [disabled]="!isOtpComplete() || isLoading">
              <span *ngIf="!isLoading">Verify & Continue</span>
              <span *ngIf="isLoading">Verifying...</span>
            </button>
          </div>

          <div class="auth-footer" *ngIf="signupStep === 2">
            <a (click)="goBackToStep1()">‚Üê Back to Signup</a>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Add this right before the booking success modal -->
  <!-- Payment Processing Modal -->
  <div *ngIf="showProcessingModal" class="processing-modal-overlay">
    <div class="processing-modal-content">
      <div class="processing-spinner"></div>
      <p class="processing-text">Please wait while we generate your ticket and QR code...</p>
      <p class="processing-subtext">This may take a few moments</p>
    </div>
  </div>

  <!-- Booking Success Modal -->
  <app-booking-success-modal
    *ngIf="showSuccessModal"
    [qrCodeBase64]="qrCodeBase64"
    [thankYouMessage]="thankYouMessage"
    [bookingDetails]="bookingDetails"
    [bookingCode]="bookingCode"
    (close)="onSuccessModalClose()">
  </app-booking-success-modal>
</div>