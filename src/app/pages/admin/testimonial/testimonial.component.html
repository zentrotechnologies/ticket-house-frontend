<!-- MAIN CONTENT: Testimonial Listing -->
<div class="main-content content-card">
  <!-- Loading Spinner -->
  <div *ngIf="isLoading" class="text-center py-4">
    <div class="spinner-border text-primary" role="status">
      <span class="visually-hidden">Loading...</span>
    </div>
    <p class="mt-2 text-muted">Loading testimonials...</p>
  </div>

  <!-- top row: title + add button -->
  <div class="page-header">
    <h2 class="page-title">Testimonial Listing</h2>
    <div class="header-actions">
      <button
        class="btn btn-primary btn-add"
        data-bs-toggle="modal"
        data-bs-target="#addTestimonialModal"
        (click)="prepareForAdd()"
      >
        <i class="fa fa-plus"></i>&nbsp; Add Testimonial
      </button>
    </div>
  </div>

  <!-- container card -->
  <div class="card card-white" *ngIf="!isLoading">
    <!-- search / controls row -->
    <div class="table-controls">
      <div class="left-controls">
        <label class="show-label">Show</label>
        <select
          class="per-page-select"
          [(ngModel)]="itemsPerPage"
          (change)="onItemsPerPageChange()"
        >
          <option [value]="10">10</option>
          <option [value]="25">25</option>
          <option [value]="50">50</option>
        </select>
      </div>
      <div class="right-controls">
        <input
          class="search-input"
          placeholder="Search testimonials..."
          [(ngModel)]="searchText"
          (keyup)="onSearch()"
        />
      </div>
    </div>

    <!-- paginated listing table -->
    <div class="table-responsive">
      <table class="table list-table">
        <thead>
          <tr>
            <th class="col-sr">Sr. No</th>
            <th class="col-img">Profile</th>
            <th class="col-name">Name</th>
            <th class="col-designation">Designation</th>
            <th class="col-desc">Testimonial</th>
            <th class="col-status text-center">Status</th>
            <th class="col-action text-center">Action</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let testimonial of filteredTestimonials; let i = index">
            <td>{{ (currentPage - 1) * itemsPerPage + i + 1 }}</td>
            <td class="text-center">
              <div class="profile-img-container">
                <img
                  [src]="getImageUrl(testimonial.profile_img)"
                  [alt]="testimonial.name"
                  class="profile-img-small"
                />
              </div>
            </td>
            <td>{{ testimonial.name }}</td>
            <td>{{ testimonial.designation }}</td>
            <td class="testimonial-desc">{{ testimonial.description }}</td>
            <td class="text-center">
              <label class="switch">
                <input
                  type="checkbox"
                  [checked]="testimonial.active === 1"
                  (change)="toggleTestimonialStatus(testimonial)"
                  [disabled]="isLoading"
                />
                <span class="slider"></span>
              </label>
            </td>
            <td class="text-center">
              <button
                class="icon-btn"
                title="Edit"
                data-bs-toggle="modal"
                data-bs-target="#editTestimonialModal"
                (click)="editTestimonial(testimonial)"
              >
                <i class="fa fa-pen"></i>
              </button>
              <button
                class="icon-btn danger"
                title="Delete"
                data-bs-toggle="modal"
                data-bs-target="#deleteTestimonialModal"
                (click)="prepareForDelete(testimonial)"
              >
                <i class="fa fa-trash"></i>
              </button>
            </td>
          </tr>

          <!-- Empty state -->
          <tr *ngIf="filteredTestimonials.length === 0">
            <td colspan="7" class="text-center py-4">
              <div class="text-muted">
                <p>No testimonials found</p>
              </div>
            </td>
          </tr>
        </tbody>
      </table>
    </div>

    <!-- pagination footer -->
    <div class="table-footer" *ngIf="totalPages > 1">
      <div class="rows-info">
        Showing {{ getDisplayRange().start }} to {{ getDisplayRange().end }} of
        {{ getDisplayRange().total }} entries
      </div>
      <nav aria-label="Page navigation">
        <ul class="pagination">
          <li class="page-item" [class.disabled]="currentPage === 1">
            <a class="page-link" href="javascript:void(0)" (click)="goToPage(currentPage - 1)">‹</a>
          </li>
          <li
            class="page-item"
            [class.active]="page === currentPage"
            *ngFor="let page of getPageNumbers()"
          >
            <a class="page-link" href="javascript:void(0)" (click)="goToPage(page)">{{ page }}</a>
          </li>
          <li class="page-item" [class.disabled]="currentPage === totalPages">
            <a class="page-link" href="javascript:void(0)" (click)="goToPage(currentPage + 1)">›</a>
          </li>
        </ul>
      </nav>
    </div>
  </div>
</div>

<!-- ADD TESTIMONIAL MODAL -->
<div
  class="modal fade"
  id="addTestimonialModal"
  tabindex="-1"
  aria-labelledby="addTestimonialLabel"
  aria-hidden="true"
>
  <div class="modal-dialog modal-lg modal-dialog-centered">
    <div class="modal-content modal-card">
      <div class="modal-header">
        <h5 class="modal-title" id="addTestimonialLabel">Add Testimonial</h5>
        <button
          type="button"
          class="btn-close"
          data-bs-dismiss="modal"
          aria-label="Close"
          (click)="resetForm()"
        ></button>
      </div>

      <div class="modal-body">
        <form class="form-grid" (ngSubmit)="addTestimonial()">
          <!-- Profile Image Upload -->
          <div class="form-row">
            <label>Profile Image</label>
            <div class="image-upload-container">
              <div class="image-preview" *ngIf="imagePreview">
                <img [src]="imagePreview" alt="Preview" class="preview-image" />
                <button type="button" class="btn-remove-image" (click)="removeSelectedFile()">
                  <i class="fa fa-times"></i>
                </button>
              </div>
              <div class="upload-area" *ngIf="!imagePreview">
                <input
                  type="file"
                  #fileInput
                  (change)="onFileSelected($event)"
                  accept="image/*"
                  class="file-input"
                />
                <div class="upload-placeholder">
                  <i class="fa fa-cloud-upload-alt"></i>
                  <p>Click to upload profile image</p>
                  <small class="text-muted">JPEG, PNG, GIF, BMP, WebP (Max 5MB)</small>
                </div>
              </div>
            </div>
          </div>

          <div class="form-row">
            <label>Name *</label>
            <input
              type="text"
              class="form-control"
              placeholder="Enter person's name"
              [(ngModel)]="currentTestimonial.name"
              name="name"
              required
            />
          </div>

          <div class="form-row">
            <label>Designation</label>
            <input
              type="text"
              class="form-control"
              placeholder="Enter designation/position"
              [(ngModel)]="currentTestimonial.designation"
              name="designation"
            />
          </div>

          <div class="form-row">
            <label>Testimonial Description *</label>
            <textarea
              class="form-control"
              rows="5"
              placeholder="Enter testimonial content"
              [(ngModel)]="currentTestimonial.description"
              name="description"
              required
            ></textarea>
          </div>
        </form>
      </div>

      <div class="modal-footer">
        <button
          type="button"
          class="btn btn-secondary"
          data-bs-dismiss="modal"
          (click)="resetForm()"
        >
          Cancel
        </button>
        <button
          type="button"
          class="btn btn-primary btn-modal-add"
          (click)="addTestimonial()"
          [disabled]="
            !currentTestimonial.name.trim() || !currentTestimonial.description.trim() || isLoading
          "
        >
          <i class="fa fa-plus"></i> Add Testimonial
        </button>
      </div>
    </div>
  </div>
</div>

<!-- EDIT TESTIMONIAL MODAL -->
<div
  class="modal fade"
  id="editTestimonialModal"
  tabindex="-1"
  aria-labelledby="editTestimonialLabel"
  aria-hidden="true"
>
  <div class="modal-dialog modal-lg modal-dialog-centered">
    <div class="modal-content modal-card">
      <div class="modal-header">
        <h5 class="modal-title" id="editTestimonialLabel">Edit Testimonial</h5>
        <button
          type="button"
          class="btn-close"
          data-bs-dismiss="modal"
          aria-label="Close"
          (click)="resetForm()"
        ></button>
      </div>

      <div class="modal-body">
        <form class="form-grid" (ngSubmit)="updateTestimonial()">
          <!-- Profile Image Upload -->
          <div class="form-row">
            <label>Profile Image</label>
            <div class="image-upload-container">
              <div class="image-preview" *ngIf="imagePreview">
                <img [src]="imagePreview" alt="Preview" class="preview-image" />
                <button type="button" class="btn-remove-image" (click)="removeSelectedFile()">
                  <i class="fa fa-times"></i>
                </button>
              </div>
              <!-- In the edit modal section, update this part: -->
              <div class="upload-area" *ngIf="!imagePreview && currentTestimonial.profile_img">
                <img
                  [src]="getImageUrl(currentTestimonial.profile_img)"
                  [alt]="currentTestimonial.name"
                  class="preview-image"
                  onerror="this.src='./assets/default-avatar.png'"
                />
                <input
                  type="file"
                  #fileInput
                  (change)="onFileSelected($event)"
                  accept="image/*"
                  class="file-input"
                />
                <div class="upload-overlay">
                  <i class="fa fa-camera"></i>
                  <p>Change Image</p>
                </div>
              </div>
              <div class="upload-area" *ngIf="!imagePreview && !currentTestimonial.profile_img">
                <input
                  type="file"
                  #fileInput
                  (change)="onFileSelected($event)"
                  accept="image/*"
                  class="file-input"
                />
                <div class="upload-placeholder">
                  <i class="fa fa-cloud-upload-alt"></i>
                  <p>Click to upload profile image</p>
                  <small class="text-muted">JPEG, PNG, GIF, BMP, WebP (Max 5MB)</small>
                </div>
              </div>
            </div>
          </div>

          <div class="form-row">
            <label>Name *</label>
            <input
              type="text"
              class="form-control"
              placeholder="Enter person's name"
              [(ngModel)]="currentTestimonial.name"
              name="editName"
              required
            />
          </div>

          <div class="form-row">
            <label>Designation</label>
            <input
              type="text"
              class="form-control"
              placeholder="Enter designation/position"
              [(ngModel)]="currentTestimonial.designation"
              name="editDesignation"
            />
          </div>

          <div class="form-row">
            <label>Testimonial Description *</label>
            <textarea
              class="form-control"
              rows="5"
              placeholder="Enter testimonial content"
              [(ngModel)]="currentTestimonial.description"
              name="editDescription"
              required
            ></textarea>
          </div>
        </form>
      </div>

      <div class="modal-footer">
        <button
          type="button"
          class="btn btn-secondary"
          data-bs-dismiss="modal"
          (click)="resetForm()"
        >
          Cancel
        </button>
        <button
          type="button"
          class="btn btn-primary btn-modal-update"
          (click)="updateTestimonial()"
          [disabled]="
            !currentTestimonial.name.trim() || !currentTestimonial.description.trim() || isLoading
          "
        >
          <i class="fa fa-save"></i> Update Testimonial
        </button>
      </div>
    </div>
  </div>
</div>

<!-- DELETE CONFIRMATION MODAL -->
<div
  class="modal fade"
  id="deleteTestimonialModal"
  tabindex="-1"
  aria-labelledby="deleteTestimonialLabel"
  aria-hidden="true"
>
  <div class="modal-dialog modal-md modal-dialog-centered">
    <div class="modal-content modal-card">
      <div class="modal-header">
        <h5 class="modal-title" id="deleteTestimonialLabel">Delete Testimonial</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>

      <div class="modal-body">
        <div>
          <h6 class="mb-3">Are you sure you want to delete this testimonial?</h6>
          <p class="text-muted" *ngIf="testimonialToDelete">
            <strong>{{ testimonialToDelete.name }}</strong> - {{ testimonialToDelete.designation }}
          </p>
        </div>
      </div>

      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button
          type="button"
          class="btn btn-danger"
          (click)="confirmDelete()"
          [disabled]="isLoading"
        >
          <i class="fa fa-trash"></i> Delete
        </button>
      </div>
    </div>
  </div>
</div>
